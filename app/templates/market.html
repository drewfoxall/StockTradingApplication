<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Buy/Sell Stocks</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/stylesheet.css') }}"
    />
  </head>
  <body>
    <div class="topnav">
      <a href="{{ url_for('index') }}"> Home </a>
      <a href="{{ url_for('view_portfolio') }}"> Portfolio </a>
      {% if current_user.is_authenticated %}
        <a href="{{url_for('market') }}"> Market </a>
        {% if current_user.is_admin %}
        <a href="{{url_for('administrator')}}"> Administrator </a>
        {% endif %}
      {% endif %}
      <div class="topnav-right">
        {% if current_user.is_authenticated %}
          <!-- Show Sign Out link when the user is logged in -->
          <a href="{{ url_for('logout') }}"> Sign Out </a>
          
        {% else %}
          <!-- Show Log in and Sign Up links when the user is not logged in -->
          <a href="{{ url_for('login') }}"> Log In </a>
          <a href="{{ url_for('signup') }}"> Sign Up </a>
        {% endif %}
      </div>
    </div>
    <div class="market-status">
      Market Status: 
      {% if is_market_open %}
          <span class="status-open">Open</span>
      {% else %}
          <span class="status-closed">Closed</span>
      {% endif %}
    </div>
    <div class="buy-sell-container">
      <h1>Buy/Sell Stocks</h1>
      {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
          <ul class="flashes">
              {% for category, message in messages %}
                  <li class="{{ category }}">{{ message }}</li>
              {% endfor %}
          </ul>
      {% endif %}
      {% endwith %}
      <!DOCTYPE html>
  <div class="buy-sell-container">
    <h3>Your cash balance: ${{ "{:,.2f}".format(current_user.cash_balance) }}</h3>
    <h2>Buy Stocks</h2>
    <table id="stock-table">
      <thead>  
        <tr>
            <th>Stock Symbol</th>
            <th>Stock Name</th>
            <th>Current Price</th>
            <th>Percent Change</th>
            <th>Available Volume</th>
            <th>Market Cap</th>  
            <th>High</th>  
            <th>Low</th>  
            <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for stock_item in all_stocks %}
        <tr data-stock-id="{{ stock_item.stock_id }}">
            <td>{{ stock_item.ticker }}</td>
            <td>{{ stock_item.company_name }}</td>
            <td class="price">${{ '{:,.2f}'.format(stock_item.price) }}</td>
            <td class="percent-change"></td>
            <td class="volume">{{ '{:,.2f}'.format(stock_item.volume) }}</td>
            <td class="market-cap">${{ '{:,.2f}'.format(stock_item.market_cap) }}</td>  
            <td class="daily-high">${{ '{:,.2f}'.format(stock_item.daily_high) }}</td>  
            <td class="daily-low">${{ '{:,.2f}'.format(stock_item.daily_low) }}</td>  
            <td>
            <form 
              id="buy-form-{{ stock_item.stock_id }}"  
              action="{{ url_for('buy_stock', stock_id=stock_item.stock_id) }}" 
              method="POST">
              <input type="number" name="quantity" min="1" max="{{ stock_item.volume }}" placeholder="Quantity" required />
              <button type="submit" class="btn">Buy</button>
            </form>
            </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    
    <script>
    // Function to format number as currency
    function formatCurrency(number) {
        return '$' + parseFloat(number).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    
    // Function to format number with commas
    function formatNumber(number) {
        return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }
    
    // Function to update stock data
    // function updateStockData() {
    //     fetch('/api/stocks')  // You'll need to create this endpoint
    //         .then(response => response.json())
    //         .then(stocks => {
    //             stocks.forEach(stock => {
    //                 const row = document.querySelector(`tr[data-stock-id="${stock.stock_id}"]`);
    //                 if (row) {
    //                     // Update price with color animation
    //                     const priceCell = row.querySelector('.price');
    //                     const oldPrice = parseFloat(priceCell.textContent.replace('$', ''));
    //                     const newPrice = parseFloat(stock.price);
    //                     priceCell.textContent = formatCurrency(newPrice);
    //                     priceCell.style.backgroundColor = newPrice > oldPrice ? '#d4edda' : 
    //                                                     newPrice < oldPrice ? '#f8d7da' : 'transparent';
    //                     // setTimeout(() => priceCell.style.backgroundColor = 'transparent', 1000);
    
    //                     // Update other fields
    //                     row.querySelector('.volume').innerHTML = stock.volume;
    //                     row.querySelector('.market-cap').innerHTML = '$' + formatNumber(stock.market_cap);
    //                     row.querySelector('.daily-high').innerHTML = formatCurrency(stock.daily_high);
    //                     row.querySelector('.daily-low').innerHTML = formatCurrency(stock.daily_low);
    
    //                     // Update the max quantity in the buy form
    //                     const quantityInput = row.querySelector('input[name="quantity"]');
    //                     if (quantityInput) {
    //                         quantityInput.max = stock.volume;
    //                     }
    //                 }
    //             });
    //         })
    //         .catch(error => console.error('Error updating stock data:', error));
    // }
    
    function updateStockData() {
      fetch('/api/stocks')  // You'll need to create this endpoint
          .then(response => response.json())
          .then(stocks => {
              stocks.forEach(stock => {
                  const row = document.querySelector(`tr[data-stock-id="${stock.stock_id}"]`);
                  if (row) {
                      // Update price with color animation
                      const priceCell = row.querySelector('.price');
                      const oldPrice = parseFloat(priceCell.textContent.replace('$', ''));
                      const newPrice = parseFloat(stock.price);
                      priceCell.textContent = formatCurrency(newPrice);
                      priceCell.style.backgroundColor = newPrice > oldPrice ? '#d4edda' : 
                                                      newPrice < oldPrice ? '#f8d7da' : 'transparent';
                      
                      // Calculate percent change
                      const percentChange = ((newPrice - oldPrice) / oldPrice * 100).toFixed(2);
                      const arrow = newPrice > oldPrice ? '↑' : newPrice < oldPrice ? '↓' : '';
                      const percentChangeCell = row.querySelector('.percent-change');
                      percentChangeCell.innerHTML = `${arrow} ${percentChange}%`;

                      // Update other fields
                      row.querySelector('.volume').innerHTML = stock.volume;
                      row.querySelector('.market-cap').innerHTML = '$' + formatNumber(stock.market_cap);
                      row.querySelector('.daily-high').innerHTML = formatCurrency(stock.daily_high);
                      row.querySelector('.daily-low').innerHTML = formatCurrency(stock.daily_low);

                      // Update the max quantity in the buy form
                      const quantityInput = row.querySelector('input[name="quantity"]');
                      if (quantityInput) {
                          quantityInput.max = stock.volume;
                      }
                  }
              });
          })
          .catch(error => console.error('Error updating stock data:', error));
    }

    // Update stock data every 30 seconds
    setInterval(updateStockData, 30000);
    
    // Initial update
    updateStockData();
    
    // Handle buy form submissions
    document.querySelectorAll('[id^="buy-form-"]').forEach(form => {
        form.addEventListener('submit', function(event) {
            event.preventDefault();
            if (confirm('Are you sure you want to buy this stock?')) {
                this.submit();
            }
        });
    });
    </script>
    <h2>Sell Stocks</h2>
    <table>
      <tbody>
        {% for stock_item in user_stocks %}
        <tr>
          <td>{{ stock_item.ticker }}</td>
          <td>{{ stock_item.company_name }}</td>
          <td>${{ '{:,.2f}'.format(stock_item.price) }}</td>
          <td>{{ stock_item.stock_portfolios[0].quantity }}</td>
          <td>
            <form 
              id="sell-form-{{ stock_item.stock_id }}"  {# Add ID to the form #}
              action="{{ url_for('sell_stock', stock_id=stock_item.stock_id) }}" 
              method="POST">
              <input type="number" name="quantity" min="1" max="{{ stock_item.stock_portfolios[0].quantity }}" placeholder="Quantity" required />
              <button type="submit" class="btn">Sell</button>
            </form>
            <script>
              document.getElementById('sell-form-{{ stock_item.stock_id }}').addEventListener('submit', function(event) {
                event.preventDefault(); // Prevent default submission
                if (confirm('Are you sure you want to sell this stock?')) {
                  this.submit(); // Submit the form if confirmed
                }
              });
            </script>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</body>
</html>